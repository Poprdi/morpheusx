# Cargo Documentation Generation and Publishing
#
# Builds rustdoc for all workspace crates and publishes to GitHub Pages.
#
# - Generates PUBLIC docs (without private items) under /api/
# - Generates INTERNAL docs (with private items) under /internal/
# - Creates a root index page linking to both with clear warnings
# - Publishes to gh-pages branch automatically on push to master
# - Adds robots.txt controls to discourage indexing of internal docs

name: Cargo Doc

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.85"
  RUSTFLAGS: "--cap-lints warn"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build public API documentation
        run: |
          # Build docs for all workspace crates WITHOUT private items (public API)
          cargo doc \
            --workspace \
            --all-features \
            --no-deps
        env:
          RUSTFLAGS: "-D warnings"

      - name: Move public docs to api directory
        run: |
          mkdir -p docs-output/api
          mv target/doc/* docs-output/api/

      - name: Build internal API documentation
        run: |
          # Build docs for all workspace crates WITH private items (internal API)
          cargo doc \
            --workspace \
            --all-features \
            --no-deps \
            --document-private-items
        env:
          RUSTFLAGS: "-D warnings"

      - name: Move internal docs to internal directory
        run: |
          mkdir -p docs-output/internal
          mv target/doc/* docs-output/internal/

      - name: Add robots.txt for internal docs
        run: |
          cat > docs-output/internal/robots.txt << 'EOF'
          User-agent: *
          Disallow: /
          EOF

      - name: Add noindex meta to internal docs index
        run: |
          # Add noindex meta tag to internal documentation pages
          # Insert after <head> tag to avoid issues with existing head content
          find docs-output/internal -name "*.html" -type f -exec sed -i 's|<head>|<head>\n    <meta name="robots" content="noindex, nofollow">|' {} \;

      - name: Add root index
        run: |
          cat > docs-output/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>MorpheusX Documentation</title>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                margin: 0;
                padding: 2rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
              }
              .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                border-radius: 8px;
                padding: 2rem;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
              }
              h1 {
                margin-top: 0;
                color: #333;
                border-bottom: 3px solid #667eea;
                padding-bottom: 0.5rem;
              }
              .intro {
                color: #666;
                line-height: 1.6;
                font-size: 1.1rem;
              }
              .doc-section {
                margin-top: 2rem;
                padding: 2rem;
                border: 2px solid #ddd;
                border-radius: 8px;
                transition: all 0.3s ease;
              }
              .doc-section:hover {
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
              }
              .doc-section h2 {
                margin-top: 0;
                color: #333;
              }
              .doc-section.warning {
                background: #fff3cd;
                border-color: #ffc107;
              }
              .doc-section.warning h2 {
                color: #856404;
              }
              .doc-link {
                display: inline-block;
                margin-top: 1rem;
                padding: 0.75rem 1.5rem;
                background: #667eea;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-weight: 600;
                transition: background 0.3s ease;
              }
              .doc-link:hover {
                background: #5568d3;
              }
              .warning-text {
                color: #856404;
                font-weight: 600;
                margin: 1rem 0;
              }
              footer {
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px solid #ddd;
                text-align: center;
                color: #999;
                font-size: 0.9rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîß MorpheusX Documentation</h1>
              
              <div class="intro">
                <p>
                  MorpheusX is a UEFI/bare-metal bootloader and exokernel with self-persisting runtime capabilities.
                  Choose the appropriate documentation set below.
                </p>
              </div>

              <div class="doc-section">
                <h2>üìñ Public API Documentation</h2>
                <p>
                  Complete public API reference for all workspace crates. This documentation is intended for
                  external users, library consumers, and those interested in the public interfaces only.
                </p>
                <p>
                  <strong>Includes:</strong> Public types, functions, modules, and traits across all crates.
                </p>
                <a href="api/" class="doc-link">View Public API Docs ‚Üí</a>
              </div>

              <div class="doc-section warning">
                <h2>‚ö†Ô∏è Internal API Documentation (Maintainers Only)</h2>
                <p class="warning-text">
                  WARNING: Internal documentation includes private implementation details, internal APIs, 
                  and unstable interfaces intended for maintainers and core contributors only.
                </p>
                <p>
                  This documentation is published for transparency and to assist maintainers. It includes
                  all private items, implementation details, and internal structure. External users should
                  refer to the Public API documentation instead.
                </p>
                <p>
                  <strong>Scope:</strong> Private modules, internal functions, implementation details, unsafe internals.
                </p>
                <a href="internal/" class="doc-link">View Internal API Docs ‚Üí</a>
              </div>

              <footer>
                <p>MorpheusX ‚Ä¢ <a href="https://github.com/Poprdi/morpheusx" style="color: #667eea;">View on GitHub</a></p>
              </footer>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-output
          retention-days: 1

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment on PR with docs location
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìö Documentation built! Both public and internal API docs have been generated. View in build artifacts.'
            })

  # Optional: Lint documentation
  doc-lint:
    name: Lint Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Check documentation syntax
        run: |
          cargo test --doc --all --all-features 2>&1 | grep -E "^(test|running|failures:|passed)" || true
        continue-on-error: true

      - name: Check for missing docs
        run: |
          # Warn about missing documentation on public items
          cargo doc \
            --workspace \
            --all-features \
            --no-deps 2>&1 | grep -E "warning.*missing.*doc" || true
        continue-on-error: true
